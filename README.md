# Telegram Message Interceptor Bot

Telegram-бот для перехвата и перенаправления сообщений между чатами с маршрутизацией по префиксам в разные темы. Бот отслеживает сообщения, начинающиеся с `/`, в исходном чате и автоматически отправляет их в соответствующие темы целевого чата.

## Возможности

- Перехват сообщений, начинающихся с `/` в указанном чате или чатах
- Поддержка нескольких исходных чатов одновременно
- Маршрутизация сообщений в разные темы по префиксу (например, `/sky 27.5` → тема "Скай")
- Автоматический ответ со списком доступных тем при использовании неизвестного префикса
- Автоматическое добавление информации об отправителе
- Гибкая настройка префиксов и тем через `.env` файл
- Логирование всех операций

## Требования

- Python 3.8 или выше
- Telegram Bot Token (получить у [@BotFather](https://t.me/botfather))
- Целевой чат должен быть Supergroup с включенными темами (Topics)
- Права администратора для бота в обоих чатах

## Установка

1. Клонируйте репозиторий или скачайте файлы проекта

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` на основе `.env.example`:
```bash
cp .env.example .env
```

4. Отредактируйте `.env` файл и заполните необходимые данные:

**Вариант 1: Один исходный чат**
```
BOT_TOKEN=ваш_токен_бота
SOURCE_CHAT_ID=id_исходного_чата
TARGET_CHAT_ID=id_целевого_чата
TOPIC_ROUTING=sky:123,earth:456,ocean:789
```

**Вариант 2: Несколько исходных чатов**
```
BOT_TOKEN=ваш_токен_бота
SOURCE_CHAT_IDS=-1001234567890,-1009876543210,-1005555555555
TARGET_CHAT_ID=id_целевого_чата
TOPIC_ROUTING=sky:123,earth:456,ocean:789
```

Где `sky:123` означает, что сообщения с префиксом `/sky` будут отправляться в тему с ID 123.

**Примечание:** Используйте либо `SOURCE_CHAT_ID` (для одного чата), либо `SOURCE_CHAT_IDS` (для нескольких чатов). При использовании `SOURCE_CHAT_IDS` перечислите ID чатов через запятую.

## Получение Chat ID и Topic ID

### Получение Chat ID

Чтобы узнать ID чата, используйте вспомогательный скрипт:

1. Запустите скрипт:
```bash
python get_chat_id.py
```

2. Отправьте любое сообщение в чат с ботом (можно добавить бота в группу)

3. Скрипт выведет информацию о чате, включая Chat ID

4. Скопируйте Chat ID и добавьте его в `.env` файл

### Получение Topic ID (ID темы)

Чтобы узнать ID темы в Supergroup:

1. Запустите скрипт:
```bash
python get_topic_id.py
```

2. Отправьте сообщение **в нужную тему** целевого чата

3. Скрипт выведет Topic ID (message_thread_id) этой темы

4. Добавьте соответствие префикса и Topic ID в `.env` файл в параметр `TOPIC_ROUTING`

## Настройка бота в Telegram

1. Создайте бота через [@BotFather](https://t.me/botfather):
   - Отправьте команду `/newbot`
   - Следуйте инструкциям и получите токен

2. Добавьте бота в оба чата (исходный и целевой)

3. **Важно:** Дайте боту права администратора в обоих чатах или убедитесь, что у него есть права:
   - Отправлять сообщения
   - Читать сообщения (для группы: отключите "Privacy Mode" у @BotFather командой `/setprivacy`)

### Отключение Privacy Mode

По умолчанию боты в группах не видят все сообщения. Чтобы исправить это:

1. Напишите [@BotFather](https://t.me/botfather)
2. Отправьте команду `/setprivacy`
3. Выберите вашего бота
4. Выберите `Disable`

## Запуск

Запустите бота командой:
```bash
python bot.py
```

Бот начнет работу и будет перехватывать сообщения из исходного чата, отправляя их в целевой чат.

## Дополнительная настройка

В файле `config.py` можно настроить:

- `INCLUDE_SENDER_INFO` - добавлять ли информацию об отправителе (по умолчанию `True`)
- `SENDER_FORMAT` - формат сообщения с информацией об отправителе
  - Доступные переменные: `{sender_name}`, `{sender_username}`, `{sender_id}`, `{message}`
  - По умолчанию: `"{message}\nОтправил: {sender_name}"`
- `DEFAULT_TOPIC_ID` - ID темы по умолчанию для неизвестных префиксов (по умолчанию `None`)

## Пример работы

### Сценарий 1: Сообщение с известным префиксом

1. В `.env` настроена маршрутизация: `TOPIC_ROUTING=sky:123`
2. Пользователь Иван в исходном чате пишет: `/sky 27.5`
3. Бот перехватывает сообщение
4. Бот отправляет в тему с ID 123 целевого чата:
   ```
   27.5
   Отправил: Иван
   ```
5. В логах появляется: "Перенаправлено сообщение с префиксом 'sky' в тему 123: 27.5... (от Иван)"

### Сценарий 2: Несколько префиксов

Настройка: `TOPIC_ROUTING=sky:123,earth:456,ocean:789`

- `/sky данные` → отправится в тему 123
- `/earth информация` → отправится в тему 456
- `/ocean значение` → отправится в тему 789
- `/unknown текст` → бот ответит: "Такой темы нет, список доступных: /earth, /ocean, /sky"

### Сценарий 3: Несколько исходных чатов

Настройка:
```
SOURCE_CHAT_IDS=-1001111111111,-1002222222222
TOPIC_ROUTING=sky:123,earth:456
```

Бот будет перехватывать сообщения с `/` из обоих чатов и отправлять их в соответствующие темы целевого чата. Это удобно для объединения сообщений из нескольких групп в один централизованный чат.

## Структура проекта

```
interceptor/
├── bot.py              # Основной файл бота
├── config.py           # Конфигурация
├── get_chat_id.py      # Вспомогательный скрипт для получения Chat ID
├── get_topic_id.py     # Вспомогательный скрипт для получения Topic ID
├── requirements.txt    # Зависимости Python
├── .env.example        # Пример файла конфигурации
├── .env                # Ваш файл конфигурации (создается вами)
├── .gitignore          # Игнорируемые файлы
└── README.md           # Документация
```

## Логирование

Бот выводит логи в консоль:
- Информация о запуске
- Перенаправленные сообщения
- Ошибки при отправке

## Решение проблем

### Бот не видит сообщения в группе
- Убедитесь, что Privacy Mode отключен у @BotFather
- Проверьте, что бот добавлен в группу

### Бот не может отправлять сообщения
- Убедитесь, что бот имеет права администратора или права на отправку сообщений
- Проверьте правильность TARGET_CHAT_ID

### Неправильный Chat ID
- Используйте `get_chat_id.py` для получения правильного ID
- Для групп ID обычно отрицательный (например, `-1001234567890`)

### Бот не отправляет сообщения в тему
- Убедитесь, что целевой чат - это Supergroup с включенными темами
- Используйте `get_topic_id.py` для получения правильного Topic ID
- Проверьте правильность формата `TOPIC_ROUTING` в `.env` (например, `sky:123,earth:456`)
- Убедитесь, что бот имеет права на отправку сообщений в темы

### Как включить темы в группе Telegram
1. Преобразуйте обычную группу в Supergroup (если еще не сделано)
2. Зайдите в настройки группы
3. Найдите пункт "Topics" или "Темы"
4. Включите темы
5. Создайте нужные темы

## Безопасность

- Не публикуйте файл `.env` с вашими токенами
- Храните BOT_TOKEN в секрете
- Регулярно проверяйте логи на предмет подозрительной активности

## Лицензия

MIT
